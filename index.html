<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeynal Haftalık Ders Programı</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Crimson+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        :root {
            --papyrus-bg-color-light: #fdf5e6;
            --papyrus-bg-color-dark: #eee0c8;
            --text-primary-color: #3e2723;
            --text-secondary-color: #6d4c41;
            --border-color: #a1887f;
            --accent-color: #795548;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --active-bg-color: #d7ccc8;

            --event-color-break: #b3e5fc;
            --event-color-religious: #c8e6c9;
            --event-color-official: #f8bbd0;
            --event-color-school-day: #bcaaa4;
            --event-color-special-day: #e1bee7;

            --event-color-text: #212121;
            --weekend-bg-color: #eeeeee;
            --weekend-text-color: #757575;

            --font-size-body: clamp(0.85rem, 1.5vw, 1rem);
            --font-size-small: clamp(0.7rem, 1.2vw, 0.8rem);
            --font-size-lesson-name: clamp(0.8rem, 2vw, 0.9rem);
            --font-size-day-title: clamp(1rem, 3vw, 1.3rem);

            --spacing-base: clamp(8px, 1.5vw, 12px);
            --spacing-small: clamp(4px, 1vw, 6px);
            --spacing-tiny: clamp(2px, 0.5vw, 4px);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Crimson Pro', serif;
            background-color: var(--papyrus-bg-color-light);
            color: var(--text-primary-color);
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            background-attachment: fixed;
            padding-bottom: 80px;
            font-size: var(--font-size-body);
        }

        header { padding: var(--spacing-small) var(--spacing-base); position: sticky; top: 4px; z-index: 1000; margin: 4px; background-color: var(--papyrus-bg-color-dark); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px var(--shadow-color); text-align: center; }
        .header-top { display: flex; align-items: center; justify-content: space-between; }
        .week-navigation { display: flex; align-items: center; gap: 10px; flex-grow: 1; justify-content: center; }
        header h1 { font-family: 'Cinzel Decorative', cursive; font-size: clamp(0.9rem, 2.5vw, 1.1rem); font-weight: 700; color: var(--accent-color); margin: 0; }
        header h2 { font-family: 'Crimson Pro', serif; font-size: var(--font-size-small); font-weight: 400; opacity: 0.8; margin-top: 2px; color: var(--text-secondary-color); }
        .day-nav { display: flex; justify-content: space-around; padding: var(--spacing-tiny); position: sticky; top: 58px; z-index: 999; margin: 4px; gap: 4px; background-color: var(--papyrus-bg-color-dark); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px var(--shadow-color); }
        .day-nav button { font-family: 'Crimson Pro', serif; padding: var(--spacing-small); font-size: var(--font-size-body); font-weight: 500; cursor: pointer; border: none; border-radius: 6px; background-color: transparent; color: var(--text-secondary-color); transition: all 0.3s ease; flex-grow: 1; }
        .day-nav button.active { background-color: var(--accent-color); color: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.15); }
        .user-name { font-family: 'Cinzel Decorative', cursive; font-size: var(--font-size-small); padding: 2px 8px; border-radius: 12px; background-color: rgba(0,0,0,0.05); color: var(--accent-color); border: 1px dashed var(--border-color); white-space: nowrap; }

        .main-container { padding: 4px; }

        #week-view-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--spacing-small);
            align-items: start;
        }
        .week-view-day-column { min-width: 0; }
        .week-view-day-title {
            font-family: 'Cinzel Decorative', cursive;
            text-align: center;
            font-size: var(--font-size-day-title);
            padding-bottom: var(--spacing-small);
            margin-bottom: var(--spacing-small);
            border-bottom: 2px solid var(--border-color);
            color: var(--accent-color);
        }

        .schedule-card {
            margin-bottom: var(--spacing-small);
            background-color: var(--papyrus-bg-color-dark);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px var(--shadow-color);
            border-left: 4px solid var(--accent-color);
            display: flex;
            flex-direction: column;
        }
        .card-header {
            padding: var(--spacing-small) var(--spacing-base);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.03);
        }
        .lesson-name {
            font-family: 'Cinzel Decorative', cursive;
            font-weight: 700;
            font-size: var(--font-size-lesson-name);
            color: var(--text-primary-color);
            text-transform: capitalize;
        }
        .lesson-time {
            font-size: var(--font-size-small);
            padding: var(--spacing-tiny) var(--spacing-small);
            border-radius: 6px;
            background-color: var(--accent-color);
            color: #fff;
            font-weight: 500;
        }
        .card-body {
            padding: var(--spacing-base);
            line-height: 1.4;
            color: var(--text-primary-color);
            flex-grow: 1;
        }
        .card-body.empty { font-style: italic; color: var(--text-secondary-color); opacity: 0.7; }

        .sidenav { height: 100%; width: 0; position: fixed; z-index: 1001; top: 0; left: 0; overflow-x: hidden; transition: 0.4s ease-out; padding-top: 60px; background-color: var(--papyrus-bg-color-dark); border-right: 2px solid var(--border-color); box-shadow: 2px 0 10px var(--shadow-color); } .sidenav a { padding: 12px 20px; text-decoration: none; font-size: 1.1rem; color: var(--text-secondary-color); display: block; transition: 0.3s; border-bottom: 1px dashed rgba(0,0,0,0.1); } .sidenav a:hover { color: var(--text-primary-color); background-color: var(--active-bg-color); } .sidenav a.active { color: var(--accent-color); font-weight: 700; background-color: var(--active-bg-color); } .sidenav .closebtn { position: absolute; top: 10px; right: 25px; font-size: 36px; color: var(--text-primary-color); }
        .menu-icon, .nav-button { font-size: 24px; cursor: pointer; background: none; border: none; color: var(--text-primary-color); padding: 2px; border-radius: 50%; transition: background 0.3s; } .nav-button:disabled { color: rgba(0,0,0,0.2); cursor: not-allowed; }
        .action-buttons-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; gap: 15px; } .action-button { width: 60px; height: 60px; background-color: var(--accent-color); color: white; border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s ease; }

        /* Takvim Modalı Stilleri */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: var(--papyrus-bg-color-light);
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        .modal-month-nav {
            display: flex;
            align-items: center;
        }

        .modal-header h2 {
            font-family: 'Cinzel Decorative', cursive;
            font-size: 1.4rem;
            color: var(--accent-color);
            text-align: center;
            margin: 0 10px;
        }

        .modal-close {
            font-size: 28px;
            color: var(--text-primary-color);
            cursor: pointer;
            position: absolute;
            top: 50%;
            right: 0px;
            transform: translateY(-50%);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        #calendar-grid-header .calendar-day-header {
            font-family: 'Cinzel Decorative', cursive;
            font-weight: 700;
            text-align: center;
            font-size: var(--font-size-small);
            padding: 5px;
            color: var(--text-secondary-color);
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-day {
            font-family: 'Crimson Pro', serif;
            font-size: var(--font-size-body);
            text-align: center;
            padding: 4px 2px;
            border-radius: 6px;
            background-color: var(--papyrus-bg-color-dark);
            border: 1px solid var(--border-color);
            min-height: 45px;
            position: relative;
            cursor: default;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .day-number {
            font-size: 0.9rem;
            line-height: 1;
        }
        .day-label {
            font-size: clamp(0.6rem, 1vw, 0.65rem);
            display: block;
            color: var(--event-color-text);
            font-weight: 500;
            line-height: 1;
            margin-top: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .calendar-day.other-month {
            opacity: 0.5;
            background-color: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary-color);
        }
        .calendar-day.today {
            font-weight: 700;
            box-shadow: 0 0 0 2px var(--accent-color) inset;
        }

        .calendar-day[style*="cursor: pointer"] {
            transition: background-color 0.2s;
        }
        .calendar-day[style*="cursor: pointer"]:hover {
            background-color: var(--active-bg-color);
        }

        .calendar-day.weekend-day {
            background-color: var(--weekend-bg-color);
            color: var(--weekend-text-color);
            cursor: not-allowed;
        }

        .calendar-day.event {
            color: var(--event-color-text);
            font-weight: 500;
            cursor: help;
        }

        .calendar-day .tooltip {
            visibility: hidden;
            width: 160px;
            background-color: var(--text-primary-color);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 2001;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: var(--font-size-small);
        }
        .calendar-day .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--text-primary-color) transparent transparent transparent;
        }
        .calendar-day.event:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .event-break { background-color: var(--event-color-break); }
        .event-religious { background-color: var(--event-color-religious); }
        .event-official { background-color: var(--event-color-official); }
        .event-school-day { background-color: var(--event-color-school-day); }
        .event-special-day { background-color: var(--event-color-special-day); }

        #calendar-legend {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: var(--font-size-small);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color-box {
            width: 15px;
            height: 15px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* DEĞİŞTİ: Takvim Alt Bilgi Stilleri */
        .calendar-footer-info {
            margin-top: 10px; /* Üstteki boşluğu azalt */
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            font-size: var(--font-size-small);
            max-height: 100px; /* YENİ EKLENDİ: Çok uzarsa scroll çıksın */
            overflow-y: auto; /* YENİ EKLENDİ */
        }
        /* DEĞİŞTİ: footer-day-group kaldırıldı, artık liste kullanılıyor */
        .calendar-footer-info ul {
            list-style: none; /* Noktaları kaldır */
            padding: 0;
            margin: 0;
        }
        .calendar-footer-info li {
            margin-bottom: 4px;
        }
        .calendar-footer-info strong { /* Kısa etiketi belirtmek için */
             display: inline-block;
             min-width: 60px; /* Hizalama için */
        }
        /* DEĞİŞTİ: footer-event kaldırıldı */

        @media print { body { padding-bottom: 0; font-size: 9pt; background-image: none; } header, .day-nav, .sidenav, .action-buttons-container, #week-view-container, #day-view-container, .modal-overlay { display: none !important; } #print-container { display: block !important; } .print-page-header { text-align: left; margin-bottom: 8px; } .print-page-header h1 { font-size: 11pt; } .print-page-header p { font-size: 9pt; } .print-days-flex-container { display: flex !important; flex-direction: row; gap: 8px; } .print-day-container { flex: 1; } .print-day-title { font-size: 10pt; } .print-card { border: 1px solid #ccc; margin-bottom: 5px; padding: 5px; } .print-card-header { font-size: 8pt; } .print-card-body { font-size: 8pt; } } #print-container { display: none; }

        @media (max-width: 480px) and (orientation: portrait) {
            .modal-content {
                padding: 10px;
                width: 95%;
            }
            .modal-header h2 {
                font-size: 1.1rem;
                margin: 0 5px;
            }
            .calendar-grid {
                gap: 2px;
            }
            .calendar-day {
                min-height: 40px;
                padding: 3px 1px;
            }
            .day-number {
                font-size: 0.8rem;
            }
            .day-label {
                font-size: 0.55rem;
                margin-top: 2px;
            }
            #calendar-grid-header .calendar-day-header {
                font-size: 0.6rem;
                padding: 3px;
            }
            #calendar-legend {
                gap: 5px;
                font-size: 0.65rem;
            }
            .calendar-footer-info {
                font-size: 0.7rem;
                max-height: 80px; /* Mobil için yüksekliği azalt */
            }
             .calendar-footer-info strong {
                 min-width: 50px;
             }
        }
    </style>
</head>
<body>
    <div id="mySidenav" class="sidenav"><a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a><div id="week-menu"></div></div>
    <header>
        <div class="header-top">
            <span class="menu-icon material-icons" onclick="openNav()">menu</span>
            <div class="week-navigation">
                <button id="prev-week-btn" class="nav-button material-icons" onclick="showPreviousWeek()">chevron_left</button>
                <h1 id="week-title-display">Yükleniyor...</h1>
                <button id="next-week-btn" class="nav-button material-icons" onclick="showNextWeek()">chevron_right</button>
            </div>
            <span class="user-name">4-D Zeynal Öğrt</span>
        </div>
        <h2 id="date-display"></h2>
    </header>
    <nav id="day-nav" class="day-nav"></nav>
    <main id="day-view-container" class="main-container"></main>
    <main id="week-view-container" class="main-container" style="display: none;"></main>
    <div class="action-buttons-container">
        <button id="calendar-btn" class="action-button" onclick="openCalendarModal()" title="Çalışma Takvimi"><i class="material-icons">calendar_month</i></button>
        <button id="toggle-view-btn" class="action-button" onclick="toggleView()" title="Hafta Görünümü"><i class="material-icons">view_week</i></button>
        <button id="print-btn" class="action-button" onclick="printSchedule()" title="Haftalık Programı Yazdır"><i class="material-icons">print</i></button>
    </div>
    <div id="print-container"></div>

    <div id="calendar-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-month-nav">
                    <button class="nav-button material-icons" id="modal-prev-month">chevron_left</button>
                    <h2 id="modal-month-year"></h2>
                    <button class="nav-button material-icons" id="modal-next-month">chevron_right</button>
                </div>
                <span class="modal-close material-icons" onclick="closeCalendarModal()">close</span>
            </div>

            <div id="calendar-grid-header" class="calendar-grid"></div>
            <div id="calendar-grid-body" class="calendar-grid"></div>

            <div id="calendar-legend"></div>
            <div id="calendar-footer-info" class="calendar-footer-info"></div>

        </div>
    </div>

    <script>
        // --- GLOBAL DEĞİŞKENLER ---
        let finalSchedule = {};
        let currentWeekIndex = 0;
        let currentDayId = 'pazartesi';
        let isWeekViewActive = false;
        let allWeeksData = [];
        const dayOrder = { pazartesi: "Pazartesi", sali: "Salı", carsamba: "Çarşamba", persembe: "Perşembe", cuma: "Cuma" };

        const weekMenu = document.getElementById('week-menu'),
            dayNav = document.getElementById('day-nav'),
            dayViewContainer = document.getElementById('day-view-container'),
            weekViewContainer = document.getElementById('week-view-container'),
            weekTitleDisplay = document.getElementById('week-title-display'),
            dateDisplay = document.getElementById('date-display'),
            prevWeekBtn = document.getElementById('prev-week-btn'),
            nextWeekBtn = document.getElementById('next-week-btn');

        let modalCurrentDate = new Date(2025, 8, 1);
        const calendarModal = document.getElementById('calendar-modal');
        const modalMonthYear = document.getElementById('modal-month-year');
        const calendarGridHeader = document.getElementById('calendar-grid-header');
        const calendarGridBody = document.getElementById('calendar-grid-body');
        const calendarLegend = document.getElementById('calendar-legend');
        const calendarFooterInfo = document.getElementById('calendar-footer-info');

        const TR_MONTH_NAMES = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        const TR_DAY_NAMES_SHORT = ["Pzt", "Sal", "Çar", "Per", "Cum", "Cmt", "Paz"];
        const TR_DAY_ID_MAP = ['pazar', 'pazartesi', 'sali', 'carsamba', 'persembe', 'cuma', 'cumartesi'];


        const academicCalendarRanges = [
            { start: "2025-11-10", end: "2025-11-14", type: "break", label: "I. Dönem Ara Tatil" },
            { start: "2026-01-19", end: "2026-01-30", type: "break", label: "Yarıyıl Tatili" },
            { start: "2026-03-16", end: "2026-03-20", type: "break", label: "II. Dönem Ara Tatil" },
            { start: "2026-03-26", end: "2026-03-29", type: "religious", label: "Ramazan Bayramı" },
            { start: "2026-05-26", end: "2026-05-30", type: "religious", label: "Kurban Bayramı" },
            { start: "2025-09-09", end: "2025-09-12", type: "special-day", label: "15 Temmuz Demokrasi ve Millî Birlik Günü Anma" },
            { start: "2025-09-15", end: "2025-09-19", type: "special-day", label: "İlköğretim Haftası" },
            { start: "2025-09-29", end: "2025-10-05", type: "special-day", label: "Disleksi Haftası" },
            { start: "2025-10-07", end: "2025-10-12", type: "special-day", label: "Ahilik Kültürü Haftası" },
            { start: "2025-10-28", end: "2025-11-03", type: "special-day", label: "Kızılay Haftası" },
            { start: "2025-11-01", end: "2025-11-08", type: "special-day", label: "Lösemili Çocuklar Haftası" },
            { start: "2025-11-03", end: "2025-11-09", type: "special-day", label: "Organ Bağışı ve Nakli Haftası" },
            { start: "2025-11-10", end: "2025-11-16", type: "special-day", label: "Atatürk Haftası" },
            { start: "2025-11-20", end: "2025-11-22", type: "special-day", label: "Ağız ve Diş Sağlığı Haftası" },
            { start: "2025-11-24", end: "2025-11-27", type: "special-day", label: "Ağız ve Diş Sağlığı Haftası" },
            { start: "2025-12-06", end: "2025-12-14", type: "special-day", label: "Mevlana Haftası" },
            { start: "2025-12-08", end: "2025-12-14", type: "special-day", label: "İnsan Hakları ve Demokrasi Haftası" },
            { start: "2025-12-12", end: "2025-12-18", type: "special-day", label: "Tutum, Yatırım ve Türk Malları Haftası" },
            { start: "2025-12-20", end: "2025-12-27", type: "special-day", label: "Mehmet Akif Ersoy'u Anma Haftası" },
            { start: "2026-01-05", end: "2026-01-11", type: "special-day", label: "Enerji Tasarrufu Haftası" },
            { start: "2026-02-23", end: "2026-03-01", type: "special-day", label: "Vergi Haftası" },
            { start: "2026-02-23", end: "2026-03-01", type: "special-day", label: "Yeşilay Haftası" },
            { start: "2026-03-02", end: "2026-03-08", type: "special-day", label: "Girişimcilik Haftası" },
            { start: "2026-03-08", end: "2026-03-14", type: "special-day", label: "Bilim ve Teknoloji Haftası" },
            { start: "2026-03-14", end: "2026-03-15", type: "special-day", label: "Tüketiciyi Koruma Haftası" },
            { start: "2026-03-16", end: "2026-03-17", type: "special-day", label: "Tüketiciyi Koruma Haftası" },
            { start: "2026-03-16", end: "2026-03-21", type: "special-day", label: "Türk Dünyası ve Toplulukları Haftası" },
            { start: "2026-03-21", end: "2026-03-26", type: "special-day", label: "Orman Haftası" },
            { start: "2026-03-22", end: "2026-03-24", type: "special-day", label: "Yaşlılar Haftası" },
            { start: "2026-03-30", end: "2026-04-05", type: "special-day", label: "Kütüphaneler Haftası" },
            { start: "2026-04-01", end: "2026-04-05", type: "special-day", label: "Kanser Haftası" },
            { start: "2026-04-07", end: "2026-04-13", type: "special-day", label: "Dünya Sağlık Günü/Dünya Sağlık Haftası" },
            { start: "2026-04-14", end: "2026-04-19", type: "special-day", label: "Turizm Haftası" },
            { start: "2026-05-04", end: "2026-05-10", type: "special-day", label: "Bilişim Haftası" },
            { start: "2026-05-04", end: "2026-05-10", type: "special-day", label: "İş Sağlığı ve Güvenliği Haftası" },
            { start: "2026-05-04", end: "2026-05-10", type: "special-day", label: "Trafik ve İlkyardım Haftası" },
            { start: "2026-05-09", end: "2026-05-16", type: "special-day", label: "Engelliler Haftası" },
            { start: "2026-05-11", end: "2026-05-16", type: "special-day", label: "Vakıflar Haftası" },
            { start: "2026-05-18", end: "2026-05-24", type: "special-day", label: "Müzeler Haftası" },
            { start: "2026-06-01", end: "2026-06-07", type: "special-day", label: "Hayat Boyu Öğrenme Haftası" },
            { start: "2026-06-08", end: "2026-06-14", type: "special-day", label: "Çevre Koruma Haftası" }
        ];

        const academicCalendarSingleDays = {
            "2025-09-08": { type: "school-day", label: "Ders Yılı Başlangıcı" },
            "2026-01-16": { type: "school-day", label: "I. Dönem Ders Yılı Bitişi" },
            "2026-02-02": { type: "school-day", label: "II. Dönem Ders Yılı Başlangıcı" },
            "2026-06-26": { type: "school-day", label: "II. Dönem Ders Yılı Bitişi" },
            "2025-10-29": { type: "official", label: "Cumhuriyet Bayramı" },
            "2026-04-23": { type: "official", label: "Ulusal Egemenlik ve Çocuk Bayramı" },
            "2026-05-19": { type: "official", label: "Atatürk'ü Anma ve Gençlik ve Spor Bayramı" },
            "2025-10-02": { type: "special-day", label: "Dünya Disleksi Günü" },
            "2025-10-04": { type: "special-day", label: "Hayvanları Koruma Günü" },
            "2025-10-13": { type: "special-day", label: "Dünya Afet Azaltma Günü" },
            "2025-10-24": { type: "special-day", label: "Birleşmiş Milletler Günü" },
            "2025-11-12": { type: "special-day", label: "Afet Eğitimi Hazırlık Günü" },
            "2025-11-14": { type: "special-day", label: "Dünya Diyabet Günü" },
            "2025-11-20": { type: "special-day", label: "Dünya Çocuk Hakları Günü" },
            "2025-11-20": { type: "special-day", label: "Dünya Felsefe Günü" },
            "2025-11-24": { type: "special-day", label: "Öğretmenler Günü" },
            "2025-11-24": { type: "special-day", label: "Ağız ve Diş Sağlığı Günü" },
            "2025-12-03": { type: "special-day", label: "Dünya Engelliler Günü" },
            "2025-12-04": { type: "special-day", label: "Dünya Madenciler Günü" },
            "2025-12-05": { type: "special-day", label: "Türk Kadınına Seçme ve Seçilme Hakkı" },
            "2025-12-25": { type: "special-day", label: "Gaziantep'in Kurtuluşu" },
            "2026-02-28": { type: "special-day", label: "Sivil Savunma Günü" },
            "2026-03-08": { type: "special-day", label: "Dünya Kadınlar Günü" },
            "2026-03-12": { type: "special-day", label: "İstiklâl Marşı'nın Kabulü" },
            "2026-03-18": { type: "special-day", label: "Şehitler Günü" },
            "2026-03-27": { type: "special-day", label: "Dünya Tiyatrolar Günü" },
            "2026-04-02": { type: "special-day", label: "Dünya Otizm Farkındalık Günü" },
            "2026-04-07": { type: "special-day", label: "Kişisel Verileri Koruma Günü" },
            "2026-04-26": { type: "special-day", label: "Dünya Fikri Mülkiyet Günü" },
            "2026-04-29": { type: "special-day", label: "Kut'ül Amâre Zaferi" },
            "2026-05-09": { type: "special-day", label: "Anneler Günü" },
            "2026-05-25": { type: "special-day", label: "Etik Günü" },
            "2026-05-29": { type: "special-day", label: "İstanbul'un Fethi" },
            "2026-06-21": { type: "special-day", label: "Babalar Günü" }
        };

        const legendData = {
            "Ara Tatil (Mavi)": "event-break",
            "Dini Bayram (Yeşil)": "event-religious",
            "Resmi Tatil (Pembe)": "event-official",
            "Belirli Gün/Hafta (Mor)": "event-special-day",
            "Okul Açılış/Kapanış": "event-school-day",
            "Hafta Sonu (Gri)": "weekend-day"
        };

        // YENİ EKLENDİ: Uzun etiketleri saklamak için
        const longLabelsMap = {};

        function openNav() { document.getElementById("mySidenav").style.width = "280px"; }
        function closeNav() { document.getElementById("mySidenav").style.width = "0"; }

        async function initializeSchedule() {
            try {
                // ... (veri yükleme kısmı aynı kaldı) ...
                 const [timetableRes, curriculumRes, weeksRes] = await Promise.all([
                    fetch('ders-programi.json'),
                    fetch('kazanimlar.json'),
                    fetch('haftalar.json')
                ]);
                const timetable = await timetableRes.json();
                const curriculum = await curriculumRes.json();
                allWeeksData = await weeksRes.json();

                const lessonCounters = {};
                for (const subject in curriculum) { lessonCounters[subject] = 0; }

                allWeeksData.forEach((week, index) => {
                    const weekKey = `week${index + 1}`;
                    finalSchedule[weekKey] = { name: week.name, dates: week.dates, days: {} };
                    for (const day in timetable) {
                        finalSchedule[weekKey].days[day] = [];
                        timetable[day].forEach((lessonName, lessonIndex) => {
                            let objective = "Kazanım veya etkinlik belirtilmemiş.";
                            if (curriculum[lessonName] && lessonCounters[lessonName] < curriculum[lessonName].length) {
                                objective = curriculum[lessonName][lessonCounters[lessonName]];
                                lessonCounters[lessonName]++;
                            }
                            finalSchedule[weekKey].days[day].push({ time: `${lessonIndex + 1}. Ders`, name: lessonName, objective: objective });
                        });
                    }
                });

                populateSideNavMenu(allWeeksData);
                populateDayNav(timetable);
                if (window.innerWidth > window.innerHeight) { isWeekViewActive = true; }
                const target = findCurrentWeekAndDay(allWeeksData);
                currentDayId = target.dayId;
                displayWeek(target.weekIndex);

                document.getElementById('modal-prev-month').addEventListener('click', () => {
                    modalCurrentDate.setMonth(modalCurrentDate.getMonth() - 1);
                    renderDynamicCalendar();
                });
                document.getElementById('modal-next-month').addEventListener('click', () => {
                    modalCurrentDate.setMonth(modalCurrentDate.getMonth() + 1);
                    renderDynamicCalendar();
                });
                calendarModal.addEventListener('click', (e) => {
                    if (e.target === calendarModal) {
                        closeCalendarModal();
                    }
                });
                populateCalendarLegend();
                renderDynamicCalendar();

            } catch (error) {
                console.error('Veri dosyaları yüklenirken bir hata oluştu:', error);
                weekTitleDisplay.textContent = "Hata!";
                dateDisplay.textContent = "Gerekli JSON dosyaları (ders-programi, kazanimlar, haftalar) yüklenemedi.";
            }
        }

        // ... (populateSideNavMenu, populateDayNav, displayWeek, displayDay, renderWeekView, showPreviousWeek, showNextWeek, toggleView, handleOrientationChange, printSchedule, parseTurkishDate, findWeekIndexForDate, findCurrentWeekAndDay aynı kaldı) ...
        function populateSideNavMenu(weeksData) {
            weekMenu.innerHTML = '';
            weeksData.forEach((week, index) => {
                const link = document.createElement('a');
                link.href = "javascript:void(0)";
                link.textContent = week.name;
                link.dataset.weekIndex = index;
                link.onclick = () => { displayWeek(index); closeNav(); };
                weekMenu.appendChild(link);
            });
        }

        function populateDayNav(timetable) {
            dayNav.innerHTML = '';
            const dayNames = { pazartesi: "Pzt", sali: "Sal", carsamba: "Çar", persembe: "Per", cuma: "Cum" };
            for(const dayId in dayOrder) {
                const button = document.createElement('button');
                button.textContent = dayNames[dayId];
                button.dataset.day = dayId;
                button.onclick = () => displayDay(dayId);
                dayNav.appendChild(button);
            }
        }

        function displayWeek(weekIndex) {
            currentWeekIndex = weekIndex;
            const weekKey = `week${weekIndex + 1}`;
            const weekData = finalSchedule[weekKey];

            if (!weekData) {
                console.error(`Hafta verisi bulunamadı: index ${weekIndex}`);
                return;
            }

            weekTitleDisplay.textContent = weekData.name;
            dateDisplay.textContent = weekData.dates;
            document.querySelectorAll('#week-menu a').forEach(a => a.classList.toggle('active', parseInt(a.dataset.weekIndex) === weekIndex));

            prevWeekBtn.disabled = weekIndex === 0;
            nextWeekBtn.disabled = weekIndex === allWeeksData.length - 1;

            if (isWeekViewActive) {
                renderWeekView();
                dayNav.style.display = 'none';
                dayViewContainer.style.display = 'none';
                weekViewContainer.style.display = 'grid';
                document.getElementById('toggle-view-btn').querySelector('i').textContent = 'view_day';
            } else {
                displayDay(currentDayId);
                dayNav.style.display = 'flex';
                dayViewContainer.style.display = 'block';
                weekViewContainer.style.display = 'none';
                document.getElementById('toggle-view-btn').querySelector('i').textContent = 'view_week';
            }
        }

        function displayDay(dayId) {
            currentDayId = dayId;
            dayViewContainer.innerHTML = '';
            const weekKey = `week${currentWeekIndex + 1}`;
            const lessons = finalSchedule[weekKey]?.days[dayId] || [];
            lessons.forEach(lesson => {
                const card = document.createElement('div');
                card.className = 'schedule-card';
                const bodyClass = lesson.objective.includes("belirtilmemiş") ? 'card-body empty' : 'card-body';
                card.innerHTML = `<div class="card-header"><span class="lesson-name">${lesson.name}</span><span class="lesson-time">${lesson.time}</span></div><div class="${bodyClass}">${lesson.objective}</div>`;
                dayViewContainer.appendChild(card);
            });
            document.querySelectorAll('#day-nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.day === dayId));
        }

        function renderWeekView() {
            weekViewContainer.innerHTML = '';
            const weekKey = `week${currentWeekIndex + 1}`;
            const weekData = finalSchedule[weekKey];
            for (const dayId in dayOrder) {
                const column = document.createElement('div');
                column.className = 'week-view-day-column';
                let lessonsHTML = `<h3 class="week-view-day-title">${dayOrder[dayId]}</h3>`;
                const lessons = weekData.days[dayId] || [];
                lessons.forEach(lesson => {
                    const bodyClass = lesson.objective.includes("belirtilmemiş") ? 'card-body empty' : 'card-body';
                    lessonsHTML += `<div class="schedule-card"><div class="card-header"><span class="lesson-name">${lesson.name}</span><span class="lesson-time">${lesson.time}</span></div><div class="${bodyClass}">${lesson.objective}</div></div>`;
                });
                column.innerHTML = lessonsHTML;
                weekViewContainer.appendChild(column);
            }
        }

        function showPreviousWeek() { if (currentWeekIndex > 0) displayWeek(currentWeekIndex - 1); }
        function showNextWeek() { if (currentWeekIndex < allWeeksData.length - 1) displayWeek(currentWeekIndex + 1); }

        function toggleView() {
            isWeekViewActive = !isWeekViewActive;
            displayWeek(currentWeekIndex);
        }

        function handleOrientationChange() {
            const isLandscape = window.innerWidth > window.innerHeight;
            if (isWeekViewActive === isLandscape) return;
            toggleView();
        }

        function printSchedule() {
            const printContainer = document.getElementById('print-container');
            const weekKey = `week${currentWeekIndex + 1}`;
            const week = finalSchedule[weekKey];
            let pageHeaderHTML = `<div class="print-page-header"><h1>${week.name}</h1><p>${week.dates}</p></div>`;
            let daysHTML = '<div class="print-days-flex-container">';
            for (const dayId in dayOrder) {
                daysHTML += `<div class="print-day-container"><h3 class="print-day-title">${dayOrder[dayId]}</h3>`;
                const lessons = week.days[dayId] || [];
                lessons.forEach(lesson => {
                    const bodyClass = lesson.objective.includes("belirtilmemiş") ? 'print-card-body empty' : 'print-card-body';
                    daysHTML += `<div class="print-card"><div class="print-card-header"><span class="print-lesson-name">${lesson.name}</span><span>${lesson.time}</span></div><div class="${bodyClass}">${lesson.objective}</div></div>`;
                });
                daysHTML += `</div>`;
            }
            daysHTML += '</div>';
            printContainer.innerHTML = pageHeaderHTML + daysHTML;
            window.print();
        }

        function parseTurkishDate(dateString) { const m = { 'ocak': 0, 'şubat': 1, 'mart': 2, 'nisan': 3, 'mayıs': 4, 'haziran': 5, 'temmuz': 6, 'ağustos': 7, 'eylül': 8, 'ekim': 9, 'kasım': 10, 'aralık': 11 }; const p = dateString.toLowerCase().split(' '); if (p.length<2) return null; const d=parseInt(p[0],10), mo=m[p[1]], y=p.length>2?parseInt(p[2],10):new Date().getFullYear(); if(isNaN(d)||mo===undefined||isNaN(y))return null; return new Date(y,mo,d); };

        function findWeekIndexForDate(targetDate) {
            if (!targetDate) return -1;
            targetDate.setHours(0, 0, 0, 0);

            for(let i = 0; i < allWeeksData.length; i++) {
                const week = allWeeksData[i];
                const dateParts = week.dates.split(' - ');
                if (dateParts.length !== 2) continue;

                const endPart = dateParts[1].split(' ');
                const year = endPart[endPart.length - 1];
                let startPart = dateParts[0].split(' ');
                if (startPart.length === 2) { startPart.push(year); }

                const startDate = parseTurkishDate(startPart.join(' '));
                const endDate = parseTurkishDate(dateParts[1]);

                if (startDate && endDate) {
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(0, 0, 0, 0);
                    if (targetDate >= startDate && targetDate <= endDate) {
                        return i;
                    }
                }
            }
            return -1;
        }

        function findCurrentWeekAndDay(weeksData) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dayOfWeek = today.getDay();
            const targetDate = new Date(today);
            if (dayOfWeek === 6) { targetDate.setDate(targetDate.getDate() + 2); }
            else if (dayOfWeek === 0) { targetDate.setDate(targetDate.getDate() + 1); }

            let todayDayId = TR_DAY_ID_MAP[dayOfWeek];
            if (dayOfWeek === 0 || dayOfWeek === 6) { todayDayId = 'pazartesi'; }

            const weekIndex = findWeekIndexForDate(targetDate);

            if (weekIndex !== -1) {
                return { weekIndex: weekIndex, dayId: todayDayId };
            }

            return { weekIndex: 0, dayId: 'pazartesi' };
        }


        // --- TAKVİM FONKSİYONLARI ---

        // DEĞİŞTİRİLDİ: getShortLabel fonksiyonu daha da kısaltıldı ve uzun etiketleri haritaya ekliyor
        function getShortLabel(label) {
            if (!label) return '';
            let shortLabel = label; // Varsayılan olarak tam etiket

            // Uzun etiketleri kısalt ve haritaya ekle
            if (label === "15 Temmuz Demokrasi ve Millî Birlik Günü Anma") shortLabel = "15 Temmuz";
            else if (label === "İlköğretim Haftası") shortLabel = "İlköğretim Hf.";
            else if (label === "Disleksi Haftası") shortLabel = "Disleksi Hf.";
            else if (label === "Ahilik Kültürü Haftası") shortLabel = "Ahilik Hf.";
            else if (label === "Kızılay Haftası") shortLabel = "Kızılay Hf.";
            else if (label === "Lösemili Çocuklar Haftası") shortLabel = "Lösemi Hf.";
            else if (label === "Organ Bağışı ve Nakli Haftası") shortLabel = "Organ Bağışı";
            else if (label === "Atatürk Haftası") shortLabel = "Atatürk Hf.";
            else if (label === "Ağız ve Diş Sağlığı Haftası") shortLabel = "Ağız/Diş Hf.";
            else if (label === "Mevlana Haftası") shortLabel = "Mevlana Hf.";
            else if (label === "İnsan Hakları ve Demokrasi Haftası") shortLabel = "İnsan Hakları";
            else if (label === "Tutum, Yatırım ve Türk Malları Haftası") shortLabel = "Yerli Malı Hf.";
            else if (label === "Mehmet Akif Ersoy'u Anma Haftası") shortLabel = "M.Akif Anma";
            else if (label === "Enerji Tasarrufu Haftası") shortLabel = "Enerji Hf.";
            else if (label === "Vergi Haftası") shortLabel = "Vergi Hf.";
            else if (label === "Yeşilay Haftası") shortLabel = "Yeşilay Hf.";
            else if (label === "Girişimcilik Haftası") shortLabel = "Girişimcilik Hf.";
            else if (label === "Bilim ve Teknoloji Haftası") shortLabel = "Bilim/Tek. Hf.";
            else if (label === "Tüketiciyi Koruma Haftası") shortLabel = "Tüketici Hf.";
            else if (label === "Türk Dünyası ve Toplulukları Haftası") shortLabel = "Türk Dünyası";
            else if (label === "Orman Haftası") shortLabel = "Orman Hf.";
            else if (label === "Yaşlılar Haftası") shortLabel = "Yaşlılar Hf.";
            else if (label === "Kütüphaneler Haftası") shortLabel = "Kütüphane Hf.";
            else if (label === "Kanser Haftası") shortLabel = "Kanser Hf.";
            else if (label === "Dünya Sağlık Günü/Dünya Sağlık Haftası") shortLabel = "Sağlık Hf.";
            else if (label === "Turizm Haftası") shortLabel = "Turizm Hf.";
            else if (label === "Bilişim Haftası") shortLabel = "Bilişim Hf.";
            else if (label === "İş Sağlığı ve Güvenliği Haftası") shortLabel = "İSG Hf.";
            else if (label === "Trafik ve İlkyardım Haftası") shortLabel = "Trafik Hf.";
            else if (label === "Engelliler Haftası") shortLabel = "Engelliler Hf.";
            else if (label === "Vakıflar Haftası") shortLabel = "Vakıflar Hf.";
            else if (label === "Müzeler Haftası") shortLabel = "Müzeler Hf.";
            else if (label === "Hayat Boyu Öğrenme Haftası") shortLabel = "Hayat Boyu Hf.";
            else if (label === "Çevre Koruma Haftası") shortLabel = "Çevre Hf.";
            else if (label === "Ulusal Egemenlik ve Çocuk Bayramı") shortLabel = "23 Nisan";
            else if (label === "Atatürk'ü Anma ve Gençlik ve Spor Bayramı") shortLabel = "19 Mayıs";
            else if (label === "Dünya Afet Azaltma Günü") shortLabel = "Afet Azaltma";
            else if (label === "Birleşmiş Milletler Günü") shortLabel = "BM Günü";
            else if (label === "Afet Eğitimi Hazırlık Günü") shortLabel = "Afet Hazırlık";
            else if (label === "Dünya Çocuk Hakları Günü") shortLabel = "Çocuk Hakları";
            else if (label === "Türk Kadınına Seçme ve Seçilme Hakkı") shortLabel = "Seçme Hakkı";
            else if (label === "Gaziantep'in Kurtuluşu") shortLabel = "G.antep Kurt.";
            else if (label === "İstiklâl Marşı'nın Kabulü") shortLabel = "İstiklâl Marşı";
            else if (label === "Dünya Otizm Farkındalık Günü") shortLabel = "Otizm G.";
            else if (label === "Kişisel Verileri Koruma Günü") shortLabel = "KVKK G.";
            else if (label === "Dünya Fikri Mülkiyet Günü") shortLabel = "Fikri Mülkiyet";
            // Diğer tekil günler için (nispeten kısa oldukları için) kısaltma gerekmez
            else if (label.includes("Ramazan Bayramı")) shortLabel = "R. Bayramı";
            else if (label.includes("Kurban Bayramı")) shortLabel = "K. Bayramı";
            else if (label.includes("Yarıyıl Tatili")) shortLabel = "Yarıyıl";
            else if (label.includes("Ara Tatil")) shortLabel = "Ara Tatil";
            else if (label.includes("Cumhuriyet Bayramı")) shortLabel = "C. Bayramı";
            else if (label.includes("Ders Yılı Başlangıcı")) shortLabel = "Okul Açık";
            else if (label.includes("Ders Yılı Bitişi")) shortLabel = "Okul Kapanış";
            else if (label.includes("Hayvanları Koruma Günü")) shortLabel = "Hayvanlar G.";
            else if (label.includes("Dünya Disleksi Günü")) shortLabel = "Disleksi G.";
            else if (label.includes("Dünya Diyabet Günü")) shortLabel = "Diyabet G.";
            else if (label.includes("Dünya Felsefe Günü")) shortLabel = "Felsefe G.";
            else if (label.includes("Öğretmenler Günü")) shortLabel = "Öğrtmnlr Günü";
            else if (label.includes("Ağız ve Diş Sağlığı Günü")) shortLabel = "Ağız/Diş G.";
            else if (label.includes("Dünya Engelliler Günü")) shortLabel = "Engelliler G.";
            else if (label.includes("Dünya Madenciler Günü")) shortLabel = "Madenciler G.";
            else if (label.includes("Sivil Savunma Günü")) shortLabel = "Sivil Savunma";
            else if (label.includes("Dünya Kadınlar Günü")) shortLabel = "Kadınlar G.";
            else if (label.includes("Şehitler Günü")) shortLabel = "Şehitler G.";
            else if (label.includes("Dünya Tiyatrolar Günü")) shortLabel = "Tiyatro G.";
            else if (label.includes("Kut'ül Amâre Zaferi")) shortLabel = "Kut'ül Amâre";
            else if (label.includes("Anneler Günü")) shortLabel = "Anneler G.";
            else if (label.includes("Etik Günü")) shortLabel = "Etik G.";
            else if (label.includes("İstanbul'un Fethi")) shortLabel = "Fetih Günü";
            else if (label.includes("Babalar Günü")) shortLabel = "Babalar G.";


            // Eğer kısaltma yapıldıysa haritaya ekle
            if (shortLabel !== label) {
                longLabelsMap[shortLabel] = label;
            }

            return shortLabel;
        }


        function openCalendarModal() {
            const weekKey = `week${currentWeekIndex + 1}`;
            const weekDates = finalSchedule[weekKey]?.dates;
            if (weekDates) {
                const startDateStr = weekDates.split(' - ')[0];
                const modalStartDate = parseTurkishDate(startDateStr);
                if (modalStartDate) {
                    modalCurrentDate = modalStartDate;
                }
            }
            renderDynamicCalendar(); // Takvimi çiz
            calendarModal.style.display = 'flex';
        }

        function navigateToDate(date) {
            const weekIndex = findWeekIndexForDate(new Date(date.getTime()));

            const dayOfWeek = date.getDay();
            const dayId = TR_DAY_ID_MAP[dayOfWeek];

            if (weekIndex !== -1 && dayId !== 'pazar' && dayId !== 'cumartesi') {

                currentDayId = dayId;
                currentWeekIndex = weekIndex;

                if (isWeekViewActive) {
                    toggleView();
                } else {
                    displayWeek(weekIndex);
                }

                closeCalendarModal();
            } else {
                console.log("Seçilen tarih bir okul günü değil:", date);
            }
        }

        function closeCalendarModal() {
            calendarModal.style.display = 'none';
        }

        function getISODateString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getEventForDate(date) {
            const dateString = getISODateString(date);
            let events = [];

            if (academicCalendarSingleDays[dateString]) {
                events.push(academicCalendarSingleDays[dateString]);
            }

            academicCalendarRanges.forEach(range => {
                const startDate = new Date(range.start + 'T00:00:00');
                const endDate = new Date(range.end + 'T00:00:00');
                 // DEĞİŞTİ: Saat dilimi sorunlarını önlemek için sadece günleri karşılaştır
                const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                if (dateOnly >= startDate && dateOnly <= endDate) {
                    events.push({ type: range.type, label: range.label });
                }
            });

            if (events.length === 0) return null;

             // Türleri tekilleştir ve etiketleri birleştir
            const uniqueTypes = [...new Set(events.map(e => e.type))];
            let uniqueEvents = uniqueTypes.map(type => {
                const eventsOfType = events.filter(e => e.type === type);
                const combinedLabel = eventsOfType.map(e => e.label).join(' / ');
                return { type: type, label: combinedLabel };
            });


            // Önceliklendir: 'break' en üste
            uniqueEvents.sort((a, b) => {
                 const priority = { 'break': 1, 'religious': 2, 'official': 3, 'school-day': 4, 'special-day': 5 };
                 return (priority[a.type] || 99) - (priority[b.type] || 99);
            });


            return uniqueEvents;
        }

        // DEĞİŞTİRİLDİ: renderDynamicCalendar fonksiyonu alt bilgi mantığını ekledi
        function renderDynamicCalendar() {
            const year = modalCurrentDate.getFullYear();
            const month = modalCurrentDate.getMonth();

            modalMonthYear.textContent = `${TR_MONTH_NAMES[month]} ${year}`;
            calendarGridHeader.innerHTML = '';
            calendarGridBody.innerHTML = '';

            // YENİ EKLENDİ: Bu ay için kısaltılmış etiketleri topla
            const currentMonthShortLabels = new Set();


            TR_DAY_NAMES_SHORT.forEach(dayName => {
                calendarGridHeader.innerHTML += `<div class="calendar-day-header">${dayName}</div>`;
            });

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();

            let dayOfWeek = firstDayOfMonth.getDay();
            let startOffset = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const prevMonthEndDate = new Date(year, month, 0).getDate();
            for (let i = 0; i < startOffset; i++) {
                const prevMonthDay = prevMonthEndDate - startOffset + 1 + i;
                calendarGridBody.innerHTML += `<div class="calendar-day other-month">
                                                   <span class="day-number">${prevMonthDay}</span>
                                               </div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                let classes = 'calendar-day';

                const dayOfWeekForClick = date.getDay();

                if (date.getTime() === today.getTime()) {
                    classes += ' today';
                }

                if (dayOfWeekForClick === 0 || dayOfWeekForClick === 6) {
                    classes += ' weekend-day';
                }

                const events = getEventForDate(date);

                let tooltipHTML = '';
                let labelHTML = '';
                let styleAttr = '';
                let primaryType = null; // Tıklama kontrolü için

                if (events && events.length > 0) {
                    const primaryEvent = events[0]; // Öncelikli olay
                    primaryType = primaryEvent.type;

                    classes += ' event';

                    const allLabels = events.map(e => e.label).join(' / ');
                    tooltipHTML = `<span class="tooltip">${allLabels}</span>`;

                    const shortLabel = getShortLabel(primaryEvent.label);
                    labelHTML = `<span class="day-label">${shortLabel}</span>`;

                    // YENİ EKLENDİ: Kısaltılmış etiketi sete ekle
                    if (longLabelsMap[shortLabel]) {
                        currentMonthShortLabels.add(shortLabel);
                    }

                    // Çoklu renk
                    if (events.length === 1) {
                         styleAttr = `style="background-color: var(--event-color-${primaryEvent.type});"`;
                     } else {
                         // Sadece farklı türdeki ilk 2 veya 3 rengi göster
                         const uniqueEventTypes = events.slice(0, 3); // En fazla 3 renk
                         if (uniqueEventTypes.length === 2) {
                             styleAttr = `style="background: linear-gradient(to bottom, var(--event-color-${uniqueEventTypes[0].type}) 50%, var(--event-color-${uniqueEventTypes[1].type}) 50%);"`;
                         } else { // 3 renk
                             styleAttr = `style="background: linear-gradient(to bottom, var(--event-color-${uniqueEventTypes[0].type}) 33.3%, var(--event-color-${uniqueEventTypes[1].type}) 33.3% 66.6%, var(--event-color-${uniqueEventTypes[2].type}) 66.6%);"`;
                         }
                     }

                }

                let onclickAttr = '';
                if (dayOfWeekForClick !== 0 && dayOfWeekForClick !== 6 && primaryType !== 'break') {
                    if (findWeekIndexForDate(date) !== -1) {
                         onclickAttr = `onclick="navigateToDate(new Date(${year}, ${month}, ${day}))" title="Bu güne git" style="cursor: pointer;"`;
                    } else if (!classes.includes('weekend-day')) {
                        onclickAttr = `style="cursor: not-allowed;"`;
                    }
                } else if (primaryType === 'break') {
                    onclickAttr = `style="cursor: not-allowed;"`;
                }

                calendarGridBody.innerHTML += `<div class="${classes}" ${onclickAttr} ${styleAttr}>
                                                   <span class="day-number">${day}</span>
                                                   ${labelHTML}
                                                   ${tooltipHTML}
                                               </div>`;
            }

            const totalCells = startOffset + daysInMonth;
            const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                 calendarGridBody.innerHTML += `<div class="calendar-day other-month">
                                                   <span class="day-number">${i + 1}</span>
                                                </div>`;
            }

            // Alt bilgiyi oluştur
            let footerHTML = '<ul>';
            if (currentMonthShortLabels.size > 0) {
                 footerHTML += '<strong>Açıklamalar:</strong>';
                 currentMonthShortLabels.forEach(shortLabel => {
                     footerHTML += `<li><strong>${shortLabel}:</strong> ${longLabelsMap[shortLabel]}</li>`;
                 });
            } else {
                footerHTML += '<li>Bu ay için kısaltılmış etkinlik bulunmamaktadır.</li>';
            }
            footerHTML += '</ul>';
            calendarFooterInfo.innerHTML = footerHTML;
        }

        function populateCalendarLegend() {
            calendarLegend.innerHTML = '';
            for (const label in legendData) {
                const type = legendData[label];
                calendarLegend.innerHTML += `
                    <div class="legend-item">
                        <div class="legend-color-box ${type}"></div>
                        <span>${label}</span>
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', initializeSchedule);
        window.addEventListener('resize', handleOrientationChange);
    </script>
</body>
</html>
